<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>3D Globe — Continent & Country Selector (MapLibre, No Token)</title>
  <link rel="preconnect" href="https://demotiles.maplibre.org" crossorigin>
  <link rel="preconnect" href="https://raw.githubusercontent.com" crossorigin>
  <style>
    html, body { height: 100%; margin: 0; }
    #app { height: 100%; display: grid; grid-template-rows: auto 1fr auto; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    header { padding: 10px 14px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    header h1 { margin: 0; font-size: 16px; }
    .controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; border: 1px solid #ddd; cursor: pointer; font-size: 12px; background: #fff; }
    .pill:hover { background: #f6f6f6; }
    .pill.active { background: #111; color: #fff; border-color: #111; }
    #map { width: 100%; height: 100vh; } /* ensure map has explicit height for iPad */
    .sidebar { position: absolute; left: 12px; top: 70px; z-index: 5; background: rgba(255,255,255,0.95); border: 1px solid #ddd; border-radius: 12px; padding: 10px 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.08); max-width: 280px; }
    .sidebar h3 { margin: 0 0 6px 0; font-size: 14px; }
    .sidebar .row { font-size: 13px; margin-top: 4px; }
    .sidebar button { margin-top: 8px; padding: 8px 10px; border-radius: 10px; border: 1px solid #111; background: #111; color: #fff; cursor: pointer; font-size: 13px; }
    .sidebar button:disabled { opacity: 0.5; cursor: not-allowed; }
    .footer { padding: 8px 14px; border-top: 1px solid #eee; font-size: 12px; color: #666; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .tip { font-size: 12px; color: #666; }
    .maplibregl-popup-content { font: 13px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>3D Globe — Select Continent, Hover & Click Country</h1>
      <div class="controls" id="controls">
        <span class="tip">Quick zoom:</span>
        <div class="pill" data-continent="world">World</div>
        <div class="pill" data-continent="africa">Africa</div>
        <div class="pill" data-continent="asia">Asia</div>
        <div class="pill" data-continent="europe">Europe</div>
        <div class="pill" data-continent="na">North America</div>
        <div class="pill" data-continent="sa">South America</div>
        <div class="pill" data-continent="oceania">Oceania</div>
        <div class="pill" data-continent="antarctica">Antarctica</div>
      </div>
    </header>
    <div style="position: relative;">
      <div id="map"></div>
      <div class="sidebar" id="sidebar">
        <h3>Selection</h3>
        <div class="row">Continent: <strong id="sel-continent">—</strong></div>
        <div class="row">Country: <strong id="sel-country">—</strong></div>
        <button id="continueBtn" disabled>Continue</button>
        <div class="tip" style="margin-top:6px;">Tip: set <code>TYPEFORM_BASE_URL</code> to redirect with hidden fields.</div>
      </div>
    </div>
    <div class="footer">
      <span><strong>Embed:</strong> Host via HTTPS and add to Typeform as a <em>Website</em> question (“Open in the form”).</span>
      <span>Drag to rotate globe • Pinch/scroll to zoom • Two-finger drag to pitch.</span>
    </div>
  </div>

  <!-- MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <script>
    // ==== CONFIG ====
    const TYPEFORM_BASE_URL = ""; // e.g., "https://form.typeform.com/to/YourFormID"
    const HIDDEN_FIELD_NAMES = { country: "country", continent: "continent" };

    // Globe map
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json', // no token
      center: [0, 20],
      zoom: 1.5,
      pitch: 45,
      bearing: 0,
      hash: false,
      attributionControl: true,
      cooperativeGestures: true
    });

    map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'top-right');

    // Try globe projection (falls back if unsupported)
    map.on('style.load', () => {
      if (map.setProjection) {
        try { map.setProjection('globe'); } catch (_) {}
      }
    });

    const CONTINENTS = {
      africa:      { name: "Africa",      center: [20, 8],    zoom: 2.6 },
      asia:        { name: "Asia",        center: [90, 30],   zoom: 2.0 },
      europe:      { name: "Europe",      center: [15, 50],   zoom: 3.0 },
      na:          { name: "North America", center: [-100, 40], zoom: 2.2 },
      sa:          { name: "South America", center: [-60, -15], zoom: 2.6 },
      oceania:     { name: "Oceania",     center: [140, -20], zoom: 2.4 },
      antarctica:  { name: "Antarctica",  center: [0, -80],   zoom: 1.6 },
      world:       { name: "World",       center: [0, 20],    zoom: 1.5 }
    };

    let activeContinentKey = 'world';
    let selectedCountry = null;

    function flyToContinent(key) {
      const c = CONTINENTS[key];
      if (!c) return;
      activeContinentKey = key;
      document.getElementById('sel-continent').textContent = c.name;
      map.flyTo({ center: c.center, zoom: c.zoom, essential: true, pitch: 45, bearing: 0 });
      applyActivePill();
      selectedCountry = null;
      document.getElementById('sel-country').textContent = '—';
      document.getElementById('continueBtn').disabled = true;
      filterCountriesByContinent();
    }

    function applyActivePill() {
      document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
      const active = document.querySelector(`.pill[data-continent="${activeContinentKey}"]`);
      if (active) active.classList.add('active');
    }

    document.getElementById('controls').addEventListener('click', (e) => {
      const pill = e.target.closest('.pill');
      if (!pill) return;
      const key = pill.getAttribute('data-continent');
      if (!key || !CONTINENTS[key]) return;
      flyToContinent(key);
    });

    // Load countries as a GeoJSON source and rendered layer
    const WORLD_GEOJSON_URL = "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson";

    map.on('load', async () => {
      const response = await fetch(WORLD_GEOJSON_URL, { mode: 'cors' });
      const world = await response.json();

      // Build a FeatureCollection with continent tag based on centroid-in-box (approximate)
      world.features.forEach(f => {
        const name = f.properties.name || f.properties.ADMIN || "Unknown";
        const centroid = turf.centroid(f).geometry.coordinates; // [lng, lat]
        f.properties._centroid = centroid;
        f.properties._continent = inferContinent(centroid);
        f.properties._name = name;
      });

      map.addSource('countries', { type: 'geojson', data: world });

      // Base fill
      map.addLayer({
        id: 'countries-fill',
        type: 'fill',
        source: 'countries',
        paint: {
          'fill-color': '#9ec5fe',
          'fill-opacity': [
            'case',
            ['boolean', ['feature-state', 'hover'], false], 0.75,
            0.45
          ]
        }
      });

      // Stroke
      map.addLayer({
        id: 'countries-outline',
        type: 'line',
        source: 'countries',
        paint: { 'line-color': '#4b5563', 'line-width': 0.6 }
      });

      // Hover highlight
      let hoveredId = null;
      map.on('mousemove', 'countries-fill', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        if (e.features.length > 0) {
          if (hoveredId !== null) {
            map.setFeatureState({ source: 'countries', id: hoveredId }, { hover: false });
          }
          const fid = e.features[0].id ?? e.features[0]._vectorTileFeature?.id ?? e.features[0].properties.name;
          hoveredId = fid;
          map.setFeatureState({ source: 'countries', id: fid }, { hover: true });
        }
      });
      map.on('mouseleave', 'countries-fill', () => {
        map.getCanvas().style.cursor = '';
        if (hoveredId !== null) {
          map.setFeatureState({ source: 'countries', id: hoveredId }, { hover: false });
        }
        hoveredId = null;
      });

      // Click to select
      map.on('click', 'countries-fill', (e) => {
        if (!e.features.length) return;
        const f = e.features[0];
        const name = f.properties._name || f.properties.name;
        selectedCountry = name;
        document.getElementById('sel-country').textContent = name;
        document.getElementById('continueBtn').disabled = false;

        const bbox = turf.bbox(f);
        const sw = [bbox[0], bbox[1]];
        const ne = [bbox[2], bbox[3]];
        map.fitBounds([sw, ne], { padding: 40, pitch: 45 });
      });

      flyToContinent('world');
    });

    function inferContinent([lng, lat]) {
      // simple bounding-box approach; good enough for filtering
      // returns one of CONTINENTS keys (except world) or 'world'
      function inBox(box) {
        const [[sLat, sLng], [nLat, nLng]] = box;
        return lat >= sLat && lat <= nLat && lng >= sLng && lng <= nLng;
      }
      const boxes = {
        africa: [[-35, -20], [38, 52]],
        asia: [[0, 26], [80, 180]],
        europe: [[35, -25], [72, 45]],
        na: [[7, -168], [83, -52]],
        sa: [[-56, -82], [13, -34]],
        oceania: [[-50, 110], [0, 180]],
        antarctica: [[-90, -180], [-60, 180]]
      };
      for (const [k, box] of Object.entries(boxes)) {
        if (inBox(box)) return k;
      }
      return 'world';
    }

    function filterCountriesByContinent() {
      if (!map.getSource('countries')) return;
      const key = activeContinentKey;
      if (key === 'world') {
        map.setFilter('countries-fill', null);
        map.setFilter('countries-outline', null);
      } else {
        map.setFilter('countries-fill', ['==', ['get', '_continent'], key]);
        map.setFilter('countries-outline', ['==', ['get', '_continent'], key]);
      }
    }

    // Continue: redirect to Typeform with hidden fields
    document.getElementById('continueBtn').addEventListener('click', () => {
      if (!selectedCountry) return;
      const continent = CONTINENTS[activeContinentKey].name;
      const country = selectedCountry;
      if (TYPEFORM_BASE_URL) {
        const params = new URLSearchParams();
        params.set(HIDDEN_FIELD_NAMES.country, country);
        params.set(HIDDEN_FIELD_NAMES.continent, continent);
        const url = TYPEFORM_BASE_URL + (TYPEFORM_BASE_URL.includes('?') ? '&' : '?') + params.toString();
        window.location.href = url;
      } else {
        alert(`Selected: ${country} (${continent}). Set TYPEFORM_BASE_URL to auto-redirect.`);
      }
    });

    // Resize fix for iPad Safari when address bar hides
    window.addEventListener('resize', () => map.resize());
  </script>
</body>
</html>
