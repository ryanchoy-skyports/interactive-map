<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>üåè Where are you from?</title>
  <style>
    html, body { height: 100%; margin: 0; }
    #app { height: 100%; display: grid; grid-template-rows: auto 1fr auto; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    header { padding: 10px 14px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    header h1 { margin: 0; font-size: 16px; }
    .controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .pill { display: inline-block; padding: 8px 14px; border-radius: 999px; border: 1px solid #ddd; cursor: pointer; font-size: 14px; background: #fff; }
    .pill:hover { background: #f6f6f6; }
    .pill.active { background: #111; color: #fff; border-color: #111; }
    #map { width: 100%; height: 100vh; }
    .sidebar { position: absolute; left: 12px; top: 70px; z-index: 5; background: rgba(255,255,255,0.95); border: 1px solid #ddd; border-radius: 12px; padding: 10px 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.08); max-width: 300px; }
    .sidebar h3 { margin: 0 0 6px 0; font-size: 14px; }
    .sidebar .row { font-size: 13px; margin-top: 6px; }
    .sidebar button { margin-top: 10px; padding: 10px 12px; border-radius: 10px; border: 1px solid #111; background: #111; color: #fff; cursor: pointer; font-size: 13px; }
    .sidebar button:disabled { opacity: 0.5; cursor: not-allowed; }
    .sidebar input, .sidebar select { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 13px; background: #fff; }
    .footer { padding: 8px 14px; border-top: 1px solid #eee; font-size: 12px; color: #666; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
  </style>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet" />
</head>
<body>
  <div id="app">
    <header>
      <h1>üåè Where are you from?</h1>
      <div class="controls" id="controls">
        <span style="font-size:12px;color:#666;">Quick zoom:</span>
        <div class="pill" data-continent="world">World</div>
        <div class="pill" data-continent="africa">Africa</div>
        <div class="pill" data-continent="asia">Asia</div>
        <div class="pill" data-continent="europe">Europe</div>
        <div class="pill" data-continent="na">North America</div>
        <div class="pill" data-continent="sa">South America</div>
        <div class="pill" data-continent="oceania">Oceania</div>
        <div class="pill" data-continent="antarctica">Antarctica</div>
      </div>
    </header>

    <div style="position: relative;">
      <div id="map"></div>
      <div class="sidebar">
        <h3>Selection</h3>
        <div class="row">Continent: <strong id="sel-continent">‚Äî</strong></div>
        <div class="row">Country: <strong id="sel-country">‚Äî</strong></div>

        <!-- ‚ñº NEW: dropdown fallback -->
        <div class="row" style="margin-top:10px;">
          <label style="font-size:12px;color:#334155;">If you can‚Äôt click your country, pick from list:</label>
          <select id="countrySelect">
            <option value="">‚Äî Select country ‚Äî</option>
          </select>
        </div>
        <!-- ‚ñº NEW: text fallback -->
        <div class="row">
          <label style="font-size:12px;color:#334155;">Or type it:</label>
          <input type="text" id="countryInput" placeholder="Start typing your country‚Ä¶" />
        </div>

        <button id="continueBtn" disabled>Continue</button>
        <div class="row" style="margin-top:6px;font-size:12px;color:#666;">2 more survey questions :)</div>
      </div>
    </div>

    <div class="footer">
      <span>Drag to rotate globe ‚Ä¢ Pinch/scroll to zoom ‚Ä¢ Two-finger drag to tilt.</span>
    </div>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script>
    // ==== REQUIRED: Insert your Mapbox token below ====
    mapboxgl.accessToken = "pk.eyJ1IjoiaGFubmFoLXNreXBvcnRzIiwiYSI6ImNtaGFnMGc3NzBwMzEya3NoeTd2MHNwdmgifQ.u8MJSsxYzPLesSUPT63C1w";

    // ==== Optional: Typeform redirect ====
    const TYPEFORM_BASE_URL = "https://form.typeform.com/to/arBzBlTZ";
    const HIDDEN_FIELD_NAMES = { country: "country", continent: "continent" };

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/satellite-streets-v12',
      center: [0, 30],    // lifted a bit so globe sits higher
      zoom: 1.6,
      pitch: 35,          // gentler tilt keeps globe near middle
      bearing: 0,
      projection: 'globe',
      cooperativeGestures: true
    });
    map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');

    const CONTINENTS = {
      africa:      { name: "Africa",      center: [20, 20],    zoom: 2.6 },
      asia:        { name: "Asia",        center: [90, 40],    zoom: 2.0 },
      europe:      { name: "Europe",      center: [15, 60],    zoom: 3.0 },
      na:          { name: "North America", center: [-100, 50], zoom: 2.2 },
      sa:          { name: "South America", center: [-60, 0],   zoom: 2.6 },
      oceania:     { name: "Oceania",     center: [140, -5],   zoom: 2.4 },
      antarctica:  { name: "Antarctica",  center: [0, -70],    zoom: 1.6 },
      world:       { name: "World",       center: [0, 30],     zoom: 1.5 }
    };

    let activeContinentKey = 'world';
    let selectedCountry = null;
    let hoveredId = null;

    // ‚ñº NEW: keep list of countries -> continent for dropdown filtering
    const countryToContinent = new Map();

    document.getElementById('controls').addEventListener('click', (e) => {
      const pill = e.target.closest('.pill');
      if (!pill) return;
      const key = pill.getAttribute('data-continent');
      if (!key || !CONTINENTS[key]) return;
      flyToContinent(key);
    });

    function flyToContinent(key) {
      const c = CONTINENTS[key];
      activeContinentKey = key;
      document.getElementById('sel-continent').textContent = c.name;
      map.flyTo({ center: c.center, zoom: c.zoom, essential: true, pitch: 35, bearing: 0 });
      applyActivePill();
      selectedCountry = null;
      document.getElementById('sel-country').textContent = '‚Äî';
      document.getElementById('continueBtn').disabled = true;
      filterCountriesByContinent();     // ‚ñº NEW
      filterDropdownByContinent();      // ‚ñº NEW
    }

    function applyActivePill() {
      document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
      const active = document.querySelector(`.pill[data-continent="${activeContinentKey}"]`);
      if (active) active.classList.add('active');
    }

    const WORLD_GEOJSON_URL = "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson";

    map.on('load', async () => {
      try { map.setFog({}); } catch (_) {}

      const res = await fetch(WORLD_GEOJSON_URL, { mode: 'cors' });
      const world = await res.json();

      world.features.forEach(f => {
        const name = f.properties.name || f.properties.ADMIN || "Unknown";
        const centroid = turf.centroid(f).geometry.coordinates;
        f.properties._name = name;
        f.properties._centroid = centroid;
        f.properties._continent = inferContinent(centroid);
        countryToContinent.set(name, f.properties._continent);

        // ‚ñº NEW: enlarge tiny countries (e.g., Singapore) so they're tappable
        const area = turf.area(f);
        if (area < 5e8) { // ~500 km¬≤
          const buffered = turf.buffer(turf.point(centroid), 0.5, { units: 'degrees' });
          f.geometry = buffered.geometry;
        }
      });

      // ‚ñº NEW: populate dropdown initially (all countries, A‚ÜíZ)
      populateDropdown(Array.from(countryToContinent.keys()));

      map.addSource('countries', { type: 'geojson', data: world, generateId: true });

      map.addLayer({
        id: 'countries-fill',
        type: 'fill',
        source: 'countries',
        paint: {
          'fill-color': '#9ec5fe',
          'fill-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 0.75, 0.45]
        }
      });

      map.addLayer({
        id: 'countries-outline',
        type: 'line',
        source: 'countries',
        paint: { 'line-color': '#4b5563', 'line-width': 0.6 }
      });

      map.on('mousemove', 'countries-fill', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        if (!e.features.length) return;
        const fid = e.features[0].id;
        if (hoveredId !== null) map.setFeatureState({ source: 'countries', id: hoveredId }, { hover: false });
        hoveredId = fid;
        map.setFeatureState({ source: 'countries', id: hoveredId }, { hover: true });
      });

      map.on('mouseleave', 'countries-fill', () => {
        map.getCanvas().style.cursor = '';
        if (hoveredId !== null) map.setFeatureState({ source: 'countries', id: hoveredId }, { hover: false });
        hoveredId = null;
      });

      map.on('click', 'countries-fill', (e) => {
        if (!e.features.length) return;
        const f = e.features[0];
        const name = f.properties._name || f.properties.name;
        selectedCountry = name;
        document.getElementById('sel-country').textContent = name;

        // ‚ñº NEW: sync UI + enable continue
        document.getElementById('countrySelect').value = name;
        document.getElementById('countryInput').value = "";
        updateContinueState();

        const bbox = turf.bbox(f);
        map.fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]], {
          padding: { top: 200, bottom: 120, left: 60, right: 60 },
          pitch: 35,
          maxZoom: 7
        });
      });

      flyToContinent('world');
    });

    function inferContinent([lng, lat]) {
      const boxes = {
        africa: [[-35, -20], [38, 52]],
        asia: [[0, 26], [80, 180]],
        europe: [[35, -25], [72, 45]],
        na: [[7, -168], [83, -52]],
        sa: [[-56, -82], [13, -34]],
        oceania: [[-50, 110], [0, 180]],
        antarctica: [[-90, -180], [-60, 180]]
      };
      for (const [k, b] of Object.entries(boxes)) {
        const [[sLat, sLng], [nLat, nLng]] = b;
        if (lat >= sLat && lat <= nLat && lng >= sLng && lng <= nLng) return k;
      }
      return 'world';
    }

    // ‚ñº NEW: filter layers by active continent
    function filterCountriesByContinent() {
      if (!map.getSource('countries')) return;
      if (activeContinentKey === 'world') {
        map.setFilter('countries-fill', null);
        map.setFilter('countries-outline', null);
      } else {
        const f = ['==', ['get', '_continent'], activeContinentKey];
        map.setFilter('countries-fill', f);
        map.setFilter('countries-outline', f);
      }
    }

    // ‚ñº NEW: populate and filter the dropdown
    function populateDropdown(names) {
      const sel = document.getElementById('countrySelect');
      // clear previous dynamic options
      Array.from(sel.querySelectorAll('option[data-cty]')).forEach(o => o.remove());
      names.sort((a,b)=>a.localeCompare(b));
      for (const name of names) {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name; opt.setAttribute('data-cty','1');
        sel.appendChild(opt);
      }
    }
    function filterDropdownByContinent() {
      const names = [];
      countryToContinent.forEach((cont, name) => {
        if (activeContinentKey === 'world' || cont === activeContinentKey) names.push(name);
      });
      populateDropdown(names);
      document.getElementById('countrySelect').value = "";
    }

    // ‚ñº NEW: helpers for dropdown/text ‚Üí enable Continue & show country line
    function updateContinueState() {
      const typed = document.getElementById('countryInput').value.trim();
      const picked = document.getElementById('countrySelect').value.trim();
      const ok = !!selectedCountry || !!picked || !!typed;
      document.getElementById('continueBtn').disabled = !ok;
      const display = selectedCountry || picked || (typed ? typed : '‚Äî');
      document.getElementById('sel-country').textContent = display;
    }
    document.getElementById('countrySelect').addEventListener('change', () => {
      selectedCountry = document.getElementById('countrySelect').value || null;
      document.getElementById('countryInput').value = "";
      updateContinueState();
    });
    document.getElementById('countryInput').addEventListener('input', () => {
      selectedCountry = null;
      document.getElementById('countrySelect').value = "";
      updateContinueState();
    });

    document.getElementById('continueBtn').addEventListener('click', () => {
      // ‚ñº UPDATED: prefer typed ‚Üí dropdown ‚Üí map click
      let country = document.getElementById('countryInput').value.trim()
                || document.getElementById('countrySelect').value.trim()
                || selectedCountry;
      if (!country) return;

      // derive continent either from active pill or the map‚Äôs index
      let contKey = activeContinentKey;
      if (countryToContinent.has(country)) contKey = countryToContinent.get(country);
      const continent = CONTINENTS[contKey]?.name || 'World';

      if (TYPEFORM_BASE_URL) {
        const params = new URLSearchParams();
        params.set(HIDDEN_FIELD_NAMES.country, country);
        params.set(HIDDEN_FIELD_NAMES.continent, continent);
        const url = TYPEFORM_BASE_URL + (TYPEFORM_BASE_URL.includes('?') ? '&' : '?') + params.toString();
        window.location.href = url;
      } else {
        alert(`Selected: ${country} (${continent}). Set TYPEFORM_BASE_URL to auto-redirect.`);
      }
    });

    window.addEventListener('resize', () => map.resize());
  </script>
</body>
</html>
